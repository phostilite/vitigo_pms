{% extends '../base.html' %}

{% block content %}
<div class="p-4 mt-14 sm:ml-64">
    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column - Appointment Form -->
        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-6">Create New Appointment</h2>
                <form method="post" id="appointment-form">
                    {% csrf_token %}
                    
                    <!-- Patient Selection -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Select Patient</label>
                        <select id="patient-select" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select a patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.get_full_name }} ({{ patient.email }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Doctor Selection -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Select Doctor</label>
                        <select id="doctor-select" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select a doctor</option>
                            {% for doctor in doctors %}
                                <option value="{{ doctor.id }}">{{ doctor.get_full_name }} ({{ doctor.email }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    {{ form.patient_id }}
                    {{ form.doctor_id }}
                    {{ form.time_slot_id }}

                    <!-- Date and Time Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Date</label>
                            {{ form.date }}
                        </div>
                        <div id="time-slots-container" style="display: none;">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Available Time Slots</label>
                            <div id="time-slots-grid" class="grid grid-cols-2 gap-2">
                                <!-- Time slots will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Type and Priority -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Appointment Type</label>
                            {{ form.appointment_type }}
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Priority</label>
                            {{ form.priority }}
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Notes</label>
                        {{ form.notes }}
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            Create Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column - Selected Info -->
        <div class="lg:col-span-1">
            <!-- Patient Info Card -->
            <div id="patient-info" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-injured mr-2 text-blue-500"></i>
                    Patient Information
                </h3>
                <div id="patient-details" class="space-y-4">
                    <div class="flex items-center justify-center h-32 text-gray-500">
                        <p><i class="fas fa-user-injured mb-2 text-3xl"></i><br>Please select a patient</p>
                    </div>
                </div>
            </div>

            <!-- Doctor Info Card -->
            <div id="doctor-info" class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-md mr-2 text-green-500"></i>
                    Doctor Information
                </h3>
                <div id="doctor-details" class="space-y-4">
                    <div class="flex items-center justify-center h-32 text-gray-500">
                        <p><i class="fas fa-user-md mb-2 text-3xl"></i><br>Please select a doctor</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('patient-select').addEventListener('change', function() {
    const patientId = this.value;
    const patientDetails = document.getElementById('patient-details');
    
    if (!patientId) {
        patientDetails.innerHTML = `
            <div class="flex items-center justify-center h-32 text-gray-500">
                <p><i class="fas fa-user-injured mb-2 text-3xl"></i><br>Please select a patient</p>
            </div>
        `;
        return;
    }
    
    fetch(`/appointments/user/${patientId}/`)
        .then(response => response.json())
        .then(data => {
            const patientDetails = document.getElementById('patient-details');
            patientDetails.innerHTML = `
                <div class="flex items-center mb-4">
                    ${data.profile_picture ? 
                        `<img src="${data.profile_picture}" class="w-16 h-16 rounded-full object-cover" 
                         onerror="this.onerror=null; this.src=''; this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden')">`
                        : ''
                    }
                    <i class="fas fa-user-circle text-6xl text-gray-400 ${data.profile_picture ? 'hidden' : ''}"></i>
                    <div class="ml-4">
                        <h4 class="font-semibold">${data.first_name} ${data.last_name}</h4>
                        <p class="text-gray-600">ID: P-${data.id}</p>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <p class="flex items-center mb-2"><i class="fas fa-envelope w-6 text-gray-500"></i> ${data.email}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-phone w-6 text-gray-500"></i> ${data.phone}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-venus-mars w-6 text-gray-500"></i> ${data.gender}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-calendar w-6 text-gray-500"></i> Joined: ${new Date(data.date_joined).toLocaleDateString()}</p>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            patientDetails.innerHTML = `
                <div class="flex items-center justify-center h-32 text-red-500">
                    <p><i class="fas fa-exclamation-circle mb-2 text-3xl"></i><br>Error loading patient details</p>
                </div>
            `;
        });
});

document.getElementById('doctor-select').addEventListener('change', function() {
    const doctorId = this.value;
    const doctorDetails = document.getElementById('doctor-details');
    
    if (!doctorId) {
        doctorDetails.innerHTML = `
            <div class="flex items-center justify-center h-32 text-gray-500">
                <p><i class="fas fa-user-md mb-2 text-3xl"></i><br>Please select a doctor</p>
            </div>
        `;
        return;
    }
    
    fetch(`/appointments/user/${doctorId}/`)
        .then(response => response.json())
        .then(data => {
            const doctorDetails = document.getElementById('doctor-details');
            doctorDetails.innerHTML = `
                <div class="flex items-center mb-4">
                    ${data.profile_picture ? 
                        `<img src="${data.profile_picture}" class="w-16 h-16 rounded-full object-cover" 
                         onerror="this.onerror=null; this.src=''; this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden')">`
                        : ''
                    }
                    <i class="fas fa-user-md text-6xl text-gray-400 ${data.profile_picture ? 'hidden' : ''}"></i>
                    <div class="ml-4">
                        <h4 class="font-semibold">Dr. ${data.first_name} ${data.last_name}</h4>
                        <p class="text-gray-600">ID: D-${data.id}</p>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <p class="flex items-center mb-2"><i class="fas fa-stethoscope w-6 text-gray-500"></i> ${data.specialization || 'Specialist'}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-envelope w-6 text-gray-500"></i> ${data.email}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-phone w-6 text-gray-500"></i> ${data.phone}</p>
                    <p class="flex items-center mb-2"><i class="fas fa-venus-mars w-6 text-gray-500"></i> ${data.gender}</p>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            doctorDetails.innerHTML = `
                <div class="flex items-center justify-center h-32 text-red-500">
                    <p><i class="fas fa-exclamation-circle mb-2 text-3xl"></i><br>Error loading doctor details</p>
                </div>
            `;
        });
});

// Function to fetch and display time slots
function fetchTimeSlots() {
    const doctorId = document.getElementById('doctor-select').value;
    const date = document.getElementById('id_date').value;
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const timeSlotsGrid = document.getElementById('time-slots-grid');
    
    if (!doctorId || !date) {
        timeSlotsContainer.style.display = 'none';
        return;
    }

    fetch(`/appointments/get-time-slots/?doctor_id=${doctorId}&date=${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.time_slots && data.time_slots.length > 0) {
                timeSlotsGrid.innerHTML = data.time_slots.map(slot => `
                    <label class="flex items-center p-2 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="time_slot" value="${slot.id}" 
                               class="form-radio text-blue-600"
                               onchange="document.getElementById('id_time_slot_id').value = this.value">
                        <span class="ml-2">${slot.start_time.slice(0, 5)} - ${slot.end_time.slice(0, 5)}</span>
                    </label>
                `).join('');
                timeSlotsContainer.style.display = 'block';
            } else {
                timeSlotsGrid.innerHTML = `
                    <p class="col-span-2 text-center text-gray-500 py-4">
                        No available time slots for this date
                    </p>`;
                timeSlotsContainer.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            timeSlotsGrid.innerHTML = `
                <p class="col-span-2 text-center text-red-500 py-4">
                    Error loading time slots
                </p>`;
            timeSlotsContainer.style.display = 'block';
        });
}

// Add event listeners for both doctor and date selection
document.getElementById('doctor-select').addEventListener('change', fetchTimeSlots);
document.getElementById('id_date').addEventListener('change', fetchTimeSlots);
</script>

{% endblock %}