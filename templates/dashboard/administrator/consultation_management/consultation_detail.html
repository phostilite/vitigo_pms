{% extends '../base.html' %}
{% load static %}
{% block content %}

{# Consultation Header #}
<div class="p-4 mt-14 sm:ml-64">
    <div class="mb-6 bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    Consultation Details
                    <span class="ml-2 text-sm font-medium px-3 py-1 rounded-full 
                        {% if consultation.status == 'COMPLETED' %}bg-green-100 text-green-800
                        {% elif consultation.status == 'SCHEDULED' %}bg-blue-100 text-blue-800
                        {% elif consultation.status == 'CANCELLED' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ consultation.get_status_display }}
                    </span>
                </h1>
                <p class="text-gray-600 mt-2">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    {{ consultation.scheduled_datetime|date:"F j, Y, g:i a" }}
                </p>
            </div>
            
            {% if can_edit_consultation %}
            <div class="flex space-x-3">
                <button class="btn-primary">
                    <i class="fas fa-edit mr-2"></i>Edit
                </button>
                <button class="btn-secondary">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    {# Main Content Grid #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {# Left Column - Patient Information #}
        <div class="lg:col-span-1">
            {# Patient Basic Info Card #}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-user-circle mr-2"></i>Patient Information
                    </h2>
                    {% if patient_info.profile_exists %}
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                            Profile Complete
                        </span>
                    {% endif %}
                </div>

                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">
                            {{ patient_info.basic_info.full_name }}
                        </h3>
                        <p class="text-gray-600">
                            <i class="fas fa-envelope mr-2"></i>{{ patient_info.basic_info.email }}
                        </p>
                        <p class="text-gray-600">
                            <i class="fas fa-phone mr-2"></i>{{ patient_info.basic_info.phone }}
                        </p>
                    </div>

                    {% if patient_info.profile_exists %}
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Date of Birth</p>
                                <p class="font-medium">{{ patient_info.profile_info.date_of_birth }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Blood Group</p>
                                <p class="font-medium">{{ patient_info.profile_info.blood_group }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">Vitiligo Onset</p>
                            <p class="font-medium">{{ patient_info.profile_info.vitiligo_onset_date }}</p>
                        </div>
                        
                        <div class="mt-4">
                            <p class="text-sm text-gray-600">Affected Areas</p>
                            <p class="font-medium">{{ patient_info.profile_info.affected_body_areas }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Medical History Card #}
            {% if medical_history %}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-notes-medical mr-2"></i>Medical History
                </h2>
                <div class="space-y-4">
                    {% if medical_history.allergies %}
                    <div>
                        <p class="text-sm text-gray-600">Allergies</p>
                        <p class="font-medium">{{ medical_history.allergies }}</p>
                    </div>
                    {% endif %}
                    
                    {% if medical_history.chronic_conditions %}
                    <div>
                        <p class="text-sm text-gray-600">Chronic Conditions</p>
                        <p class="font-medium">{{ medical_history.chronic_conditions }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Center Column - Main Consultation Details #}
        <div class="lg:col-span-2">
            {# Consultation Notes #}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-file-medical mr-2"></i>Consultation Notes
                </h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-600">Chief Complaint</p>
                        <p class="font-medium">{{ consultation.chief_complaint }}</p>
                    </div>
                    
                    {% if consultation.symptoms %}
                    <div>
                        <p class="text-sm text-gray-600">Symptoms</p>
                        <p class="font-medium">{{ consultation.symptoms }}</p>
                    </div>
                    {% endif %}
                    
                    <div>
                        <p class="text-sm text-gray-600">Diagnosis</p>
                        <p class="font-medium">{{ consultation.diagnosis }}</p>
                    </div>
                    
                    {% if consultation.clinical_notes %}
                    <div>
                        <p class="text-sm text-gray-600">Clinical Notes</p>
                        <p class="font-medium">{{ consultation.clinical_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {# Prescriptions #}
            {% if consultation.prescriptions.exists %}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-prescription mr-2"></i>Prescriptions
                </h2>
                {% for prescription in consultation.prescriptions.all %}
                <div class="mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Medication
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Dosage
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Frequency
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Duration
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in prescription.items.all %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ item.medication.name }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ item.dosage }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ item.frequency }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ item.duration }}</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {# Treatment Plan #}
            {% if payment_info %}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <i class="fas fa-clipboard-list mr-2"></i>Treatment Plan
                    </h2>
                    <span class="px-3 py-1 rounded-full text-sm font-medium
                        {% if payment_info.payment_status == 'COMPLETED' %}bg-green-100 text-green-800
                        {% elif payment_info.payment_status == 'PARTIAL' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ payment_info.payment_status }}
                    </span>
                </div>
                
                <div class="space-y-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Item
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Cost
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in payment_info.items_breakdown %}
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ item.name }}
                                    </div>
                                    {% if item.description %}
                                    <div class="text-sm text-gray-500">
                                        {{ item.description }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900">₹{{ item.cost }}</div>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="bg-gray-50">
                                <td class="px-6 py-4 font-medium">Total</td>
                                <td class="px-6 py-4 font-medium">₹{{ payment_info.total_cost }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {# Attachments #}
            {% if consultation.attachments.exists %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-paperclip mr-2"></i>Attachments
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for attachment in consultation.attachments.all %}
                    <div class="border rounded p-4 flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-file-alt text-gray-400 text-2xl mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-900">{{ attachment.title }}</p>
                                <p class="text-sm text-gray-500">
                                    Added by {{ attachment.uploaded_by.get_full_name }}
                                </p>
                            </div>
                        </div>
                        <a href="{{ attachment.file.url }}" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}